var STATE_MODE_NEW_USER=0;var STATE_MODE_RETURN_NORMAL_USER=1;var STATE_MODE_NEW_USER_NO_STORAGE=2;var STATE_MODE_USER_UNDEFINED=-1;var STATUS_EDIT=0;var STATUS_ALL_DONE=1;var STATUS_CANT_GO=2;var moment_dates=[];var euts_global=[];var state={mode:STATE_MODE_USER_UNDEFINED,yourName:"",yesDates:[]};var determinateProgress;$(function(){determinateProgress=new Mprogress({template:1,parent:"#loaderDiv"});showLoader();init()});function init(){FastClick.attach(document.body);initMoment();$.ajaxSetup({beforeSend:function(b,a){if(!csrfSafeMethod(a.type)&&!this.crossDomain){b.setRequestHeader("X-CSRFToken",csrftoken)}}});document.title=event_name+" | "+document.title;initLocalStorage();initDatesLayout();initEuts()}function tryRenderStatus(f){var g=$("#cantGo");var e=$("#edit");var c=$("#allDone");var b=$("#yourName");var a=$("#whatToDo");e.hide();g.hide();c.hide();a.hide();whatToDoManagement();var d=false;switch(f){case STATUS_EDIT:showChecks();if(state.yesDates.length==0){g.show()}else{c.show()}yourNameEnable(b);d=true;break;case STATUS_CANT_GO:if(state.yourName.length>=MIN_NAME_LENGTH){a.hide();e.show();hideChecks();yourNameDisable(b);d=true}else{g.show();blinkSomething(a);d=false}break;case STATUS_ALL_DONE:if(state.yourName.length>=MIN_NAME_LENGTH){e.show();hideChecks();yourNameDisable(b);d=true}else{c.show();blinkSomething(a);d=false}break;default:console.error("Unrecognized status_code");d=false;break}return d}function hideChecks(){$(".checkbox").hide();$(".thisUserCheck").each(function(){if(!$(this).hasClass("tdDateChecked")){$(this).addClass("tdDateNo")}});renderIcons()}function renderIcons(){var a="<i class='mdi-action-done selfIcons tdIcon'></i>";var b="<i class='mdi-content-clear selfIcons tdIcon'></i>";$(".thisUserCheck").each(function(){if($(this).hasClass("tdDateNo")){$(this).append(b)}else{$(this).append(a)}})}function showChecks(){$(".checkbox").show();$(".selfIcons").hide()}function yourNameDisable(a){a.prop("readOnly",true);a.css("borderWidth","0px")}function yourNameEnable(a){a.prop("readOnly",false);a.css("borderWidth","0px 0px 1px 0px")}function initSelfRow(c){$(".thisUserCheck").addClass("tdDateNo");if(c.length>0){state.mode=STATE_MODE_RETURN_NORMAL_USER;var a=c[0];state.yourName=a.display_user_name;state.yesDates=a.timeslots_id;state.is_organizer=a.is_organizer;nameUpdate($("#yourName"));var d=a.timeslots_id;for(var b=0;b<d.length;b++){$(".datesCheck[dateNumber="+d[b]+"]").prop("checked",true);var e=$("#tdWithCheckdate_"+d[b]);e.removeClass("tdDateNo");e.addClass("tdDateChecked")}}else{state.mode=STATE_MODE_NEW_USER}}function initUIHandlers(){$("#yourName").on("input paste",function(){console.log("input paste");whatToDoManagement();state.yourName=$(this).val();nameUpdate($(this))});$("#edit").on("click",function(){tryRenderStatus(STATUS_EDIT)});$("#shareLink").on("click",function(){$("#url-text").val(window.location.hostname+"/"+event_hid);$("#urlModal").modal("show");var a=document.getElementById("url-text");a.setSelectionRange(0,a.value.length)});$("#allDone").on("click",function(){if(tryRenderStatus(STATUS_ALL_DONE)){submitSelfStateToServer()}});$("#cantGo").on("click",function(){if(tryRenderStatus(STATUS_CANT_GO)){submitSelfStateToServer()}});$(".datesCheck").on("click",function(){var a=$("#tdWithCheckdate_"+$(this).attr("dateNumber"));if(!$(this).is(":checked")){a.removeClass("tdDateChecked");a.addClass("tdDateNo")}else{a.addClass("tdDateChecked");a.removeClass("tdDateNo")}calcWinner();collateChecks();whatToDoManagement();tryRenderStatus(STATUS_EDIT)});$(".mdi-action-delete").on("click",function(){var b=$("#myModal");b.find("#delete-display-name").text($(this).attr("data-eut-displayed-name"));var c=b.find("#confirm-btn");var a=$(this).attr("data-eut-hid");c.off();c.click({eut_hid:a},deleteEutByIdCallback);b.modal("show")})}function deleteEutByIdCallback(b){showLoader();var a=b.data.eut_hid;$.post(delete_eut_url,{eut_hid:a},function(c){endLoader();$("tr[data-eut-hid='"+a+"']").velocity("slideUp",{duration:200}).promise().done(function(){$(this).remove();calcWinner()})})}function submitSelfStateToServer(){showLoader();var a={timeslots:JSON.stringify(state.yesDates),display_user_name:state.yourName,event_hid:event_hid};if((state.mode==STATE_MODE_NEW_USER)||(state.mode==STATE_MODE_NEW_USER_NO_STORAGE)){a.is_organizer=false}else{if(state.mode==STATE_MODE_RETURN_NORMAL_USER){a.eut_hid=state.eut_hid;a.is_organizer=state.is_organizer}else{if(state.mode==STATE_MODE_USER_UNDEFINED){console.log("undefined state, do not post");return}else{console.error("Unrecognized state, do not post");return}}}console.log(a);$.post(save_eut_url,a,function(b){console.log(b);if(state.mode==STATE_MODE_NEW_USER){localStorage.setItem(event_hid,b);state.eut_hid=b;state.mode=STATE_MODE_RETURN_NORMAL_USER}endLoader()})}function collateChecks(){state.yesDates=[];$(".datesCheck:checked").each(function(){state.yesDates.push($(this).attr("dateNumber"))})}function nameUpdate(a){if(state.yourName.length>=MIN_NAME_LENGTH){if(a.val()==""){a.val(state.yourName)}a.css("borderColor","#2e7b32");a.css("color","rgba(0,0,0,.87)")}else{a.css("borderColor","#f44336");a.css("color","rgba(0,0,0,.38)")}whatToDoManagement()}function initOthersRows(f){var e="<span class='username-span'><i class='mdi-social-person' style='opacity: .54;font-size: 1em;'></i> "+f.display_user_name+"</span>";var c="<span class='delete-btn-span text-center'><i class='mdi-action-delete' data-eut-hid='"+f.eut_hid+"' data-eut-displayed-name='"+f.display_user_name+"'></i></span>";$("#leftNames").append("<tr data-eut-hid='"+f.eut_hid+"'><td class='names'>"+e+c+"</td></tr>");var d="<tr data-eut-hid='"+f.eut_hid+"'>";for(i=0;i<moment_dates.length;i++){if(i>0){if(moment_dates[i].month()!=moment_dates[i-1].month()){d+="<td class='monthSeperator'></td>"}}var a="";var b="";if(f.timeslots_id.indexOf(dates[i]["timeslot_key"])>-1){a="tdDateChecked";b="mdi-action-done"}else{a="tdDateNo";b="mdi-content-clear"}d+="<td style='text-align:center;' class='tdDate "+a+"' id='tddate_"+dates[i]["timeslot_key"]+"'><i class='"+b+" tdIcon'></i></td>"}d+="</tr>";$("#rightDates").append(d)}function calcWinner(){var b=[];$("#rightDates").find("tr").each(function(h,j){var g=[];var k=$(this).find("td");k.each(function(n,m){if($(this).hasClass("tdDateChecked")){g.push(1)}else{if($(this).hasClass("monthSeperator")){g.push(-1)}else{g.push(0)}}});var l={trId:h,scores:g};b.push(l)});b.shift();var e=[];for(z=0;z<b[0].scores.length;z++){var f=0;for(i=0;i<b.length;i++){f+=b[i].scores[z]}e.push(f)}var c=arrayAllMaxIndexes(e);$("col").removeClass("highestCol");for(u=0;u<c.length;u++){var a=c[u]+1;var d=$("col:nth-child("+a+")");d.addClass("highestCol")}$("#rightDates").velocity("fadeIn",{duration:200})}function getAllIndexes(a,d){var b=[],c=-1;if(d==0){return[]}while((c=a.indexOf(d,c+1))!=-1){b.push(c)}return b}function arrayAllMaxIndexes(a){return getAllIndexes(a,Math.max.apply(null,a))}function initEutRows(a){initSelfRow(a.self_euts);$.each(a.organizer_euts,function(c,b){initOthersRows(b)});$.each(a.normal_euts,function(b,c){initOthersRows(c)})}function initEuts(){var a={};if(state.mode==STATE_MODE_RETURN_NORMAL_USER){a.eut_hid=state.eut_hid}$.post(get_eut_url,a,function(b){euts_global=b;initEutRows(b);$.material.init();initUIHandlers();tryRenderStatus(STATUS_CANT_GO);calcWinner();endLoader()},"json")}function initMoment(){moment.locale("zh-cn");$.each(dates,function(b,a){moment_dates.push(moment(a.date,"YYYY/MM/DD"))})}function initLocalStorage(){if(typeof(Storage)!=="undefined"){var a=localStorage.getItem(event_hid);if(a!=null){state.eut_hid=a;state.mode=STATE_MODE_RETURN_NORMAL_USER}else{state.mode=STATE_MODE_NEW_USER}}else{alert("Sorry, unsupported browser, no local storage");state.mode=STATE_MODE_NEW_USER_NO_STORAGE}}function initDatesLayout(){$("#firstMonth").html(moment_dates[0].format("MMMM")+"<br/>"+moment_dates[0].format("YYYY"));var k="";var n=moment_dates.length;var e;for(e=0;e<n;e++){k+="<col>";if(e>0){if(moment_dates[e].month()!=moment_dates[e-1].month()){k+="<col>"}}}var d=$("#rightDates");d.prepend(k);var j=dates[0]["date"];var c=false;var l=false;var b=0;var p=false;for(e=0;e<moment_dates.length;e++){l=false;var m=$("#dateInserter");if(e>0){if(moment_dates[e].month()!=moment_dates[e-1].month()){var o=moment_dates[e].format("MMMM")+"<br/>"+moment_dates[e].format("YYYY");m.append("<td class='monthSeperator'>"+o+"</td>");l=true;b++}}if(dates[e]["time_type"]==TIME_TYPE_PRECISE_TIME_TIME||dates[e]["time_type"]==TIME_TYPE_MORNING_AFTERNOON_EVENING_TIME){var a=moment_dates[e].format("Do")+" "+moment_dates[e].format("ddd");p=true;c=true;if(dates[e]["time"]==""){a+="<br/>全天"}else{a+="<br/>"+dates[e]["time"]}$("#dateInserter").css("height","65px");$("#firstMonth").css("height","65px");if(dates[e]["time_type"]==TIME_TYPE_PRECISE_TIME_TIME){showSetPreciseTimeBtn()}}else{var a=moment_dates[e].format("Do")+"<br/>"+moment_dates[e].format("ddd")}if(dates[e]["date"]!=j&&c&&!l){var q=$("col:nth-child("+(e+b+1)+")");q.addClass("daySeparator")}j=dates[e]["date"];m.append("<td>"+a+"</td>")}if(p){MIN_CELL_WIDTH=MIN_WIDE_CELL_WIDTH;$("#rightDates").find("td").css("min-width",MIN_CELL_WIDTH)}var h="<tr>";for(e=0;e<moment_dates.length;e++){if(e>0){if(moment_dates[e].month()!=moment_dates[e-1].month()){h+="<td class='monthSeperator'></td>"}}h+="<td style='text-align:center;' class='tdDate thisUserCheck' id='tdWithCheckdate_"+dates[e]["timeslot_key"]+"'><div class='checkbox'><label><input type='checkbox' class='datesCheck' dateNumber='"+dates[e]["timeslot_key"]+"'/></label></div></td>"}h+="</tr>";d.append(h);var f=$(".tdDate").last().width();console.log("tdWidth:"+f);if(f<=MIN_CELL_WIDTH){console.log("Stretch Mode");var g=$("#rightScroller");g.css("width","100%");g.css("overflow-x","scroll")}}function showSetPreciseTimeBtn(){$("#set-precise-time-btn").show()}function whatToDoManagement(){var a=$("#whatToDo");if(state.yourName.length==0){a.text(" ▼ 输入名字 ");a.show()}else{if(!(state.yourName.length>=MIN_NAME_LENGTH)){a.text(" ▼ 名字长度需要大于 "+MIN_NAME_LENGTH.toString()+" ");a.show()}else{if(state.yesDates.length==0){a.text(" ▼ 选择日期或选择没有时间 ");a.show()}else{a.hide()}}}}function showLoader(){determinateProgress.start();determinateProgress.set(0.7)}function endLoader(){determinateProgress.end()}function blinkSomething(a){a.velocity("fadeIn",{duration:200}).velocity("fadeOut",{duration:200}).velocity("fadeIn",{duration:200}).velocity("fadeOut",{duration:200}).velocity("fadeIn",{duration:200})};